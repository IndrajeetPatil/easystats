---
output: 
  github_document:
    toc: false
    fig_width: 10.08
    fig_height: 6
tags: [r, reports]
vignette: >
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

# easystats

```{r, echo = FALSE}
knitr::opts_chunk$set(
  dpi = 600,
  collapse = TRUE,
  fig.path = "man/figures/"
)
options(knitr.kable.NA = '',
        digits = 4,
        width=60)
```

```{r echo=FALSE, fig.show='hold', fig.align='left', out.width="14%", out.height="14%"}
# knitr::include_graphics(c("https://github.com/easystats/insight/raw/master/man/figures/logo.png",
#                           "https://github.com/easystats/bayestestR/raw/master/man/figures/logo.png",
#                           "https://github.com/easystats/parameters/raw/master/man/figures/logo.png",
#                           "https://github.com/easystats/performance/raw/master/man/figures/logo.png",
#                           "https://github.com/easystats/estimate/raw/master/man/figures/logo.png",
#                           "https://github.com/easystats/correlation/raw/master/man/figures/logo.png",
#                           "https://github.com/easystats/report/raw/master/man/figures/logo.png"))
# 

# library(png)
# library(grid)
# library(gridExtra)
# library(RCurl)
# 
# insight <-  rasterGrob(as.raster(readPNG(getURLContent("https://github.com/easystats/insight/raw/master/man/figures/logo.png"))), interpolate = FALSE)
# bayestestR <-  rasterGrob(as.raster(readPNG(getURLContent("https://github.com/easystats/bayestestR/raw/master/man/figures/logo.png"))), interpolate = FALSE)
# grid.arrange(insight, bayestestR, ncol = 1)
```

<p>
<img src='https://github.com/easystats/insight/raw/master/man/figures/logo.png' align="left" height="102" />
<img src='https://github.com/easystats/bayestestR/raw/master/man/figures/logo.png' align="left" height="102" />
<img src='https://github.com/easystats/parameters/raw/master/man/figures/logo.png' align="left" height="102" />
<img src='https://github.com/easystats/performance/raw/master/man/figures/logo.png' align="left" height="102" />
<img src='https://github.com/easystats/estimate/raw/master/man/figures/logo.png' align="left" height="102" />
<img src='https://github.com/easystats/correlation/raw/master/man/figures/logo.png' align="left" height="102" />
<img src='https://github.com/easystats/see/raw/master/man/figures/logo.png' align="left" height="102" />
<img src='https://github.com/easystats/report/raw/master/man/figures/logo.png' align="left" height="102" />
</p>

<p><br /><br /><br /></p>
<p><br /><br /><br /></p>

The aim of **easystats** is to provide a unifying and consistent framework to tame, discipline and harness the scary R statistics and their pesky models.


# Installation

The whole `easystats` suite can be installed *at once* with the following:

```r
install.packages("devtools")
devtools::install_github("easystats/easystats")
```

```r
library("easystats")
```

# Features 

- [Compute R2s and other performance indices for all your models!](https://easystats.github.io/blog/posts/performance_presentation/)
- [How to easily generate a perfectly normal distribution](https://easystats.github.io/blog/posts/bayestestr_rnorm_perfect/)
- [Describe and understand Bayesian models and posteriors using bayestestR](https://easystats.github.io/blog/posts/bayestestr_presentation/)
- [A unified syntax for accessing models' information](https://easystats.github.io/blog/posts/insight_presentation/)
- [The end of errors in ANOVA reporting](https://easystats.github.io/blog/posts/report_anova/)
- [Formatted correlation output with effect sizes](https://easystats.github.io/blog/posts/report_correlation/)


# Dependencies
```{r message=FALSE, warning=FALSE, include=TRUE, results="hide", echo=FALSE}
library(tidyverse)
library(devtools)
library(miniCRAN)
library(igraph)
library(ggnetwork)
library(intergraph)

  
pkg <- devtools::as.package(".")

dependencies <- unlist(strsplit(paste(pkg$imports, "\n", pkg$depends), split = "\n"))[-1]
dependencies <- trimws(gsub("\\n| \\(.+\\)|,", "", dependencies))

dependency_graph <- miniCRAN::makeDepGraph(dependencies, suggests = FALSE, enhances = FALSE)
class(dependency_graph) <- "igraph"
dependency_graph <- dependency_graph + igraph::vertices(pkg$package) + igraph::edges(as.vector(rbind(dependencies, pkg$package)))
dependency_graph <- igraph::simplify(dependency_graph)

edge_list <- igraph::get.edgelist(dependency_graph)
dependency_graph <- igraph::graph(rbind(edge_list[, 2], edge_list[, 1]))

dependency_graph_df <- ggnetwork::ggnetwork(
  dependency_graph
  , layout = "fruchtermanreingold"
  , arrow.gap = 0.015
  , layout.par = list(niter = 5000)
)

dependency_graph_df$package <- dependency_graph_df$vertex.names
dependency_graph_df$face <- ifelse(dependency_graph_df$package == pkg$package, "bold", "plain")

dependency_graph_df$n_dependencies <- as.vector(table(gsub("\\|.+", "", attr(igraph::E(dependency_graph), "vnames")))[as.character(dependency_graph_df$package)])
dependency_graph_df$n_dependencies[is.na(dependency_graph_df$n_dependencies)] <- 0

dependency_graph_df$importance <- as.vector(table(gsub(".+\\|", "", attr(E(dependency_graph), "vnames")))[as.character(dependency_graph_df$package)])
dependency_graph_df$importance[is.na(dependency_graph_df$importance)] <- 0

max_downstream_deps <- max(dependency_graph_df$importance)

dependency_graph_df$importance <- dependency_graph_df$importance / max_downstream_deps
dependency_graph_df$importance <- abs(1 - dependency_graph_df$importance)

dependency_graph_df <- as.data.frame(lapply(dependency_graph_df, as.vector))

ggplot(dependency_graph_df, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_nodes(aes(color = n_dependencies), size = 6.5, alpha = 0.4) +
  geom_edges(arrow = arrow(length = unit(4, "pt"), type = "closed"), color = grey(0.4)) +
  geom_nodelabel_repel(
    aes(label = package, fontface = face, color = n_dependencies)
    , box.padding = unit(8, "pt")
  ) +
  geom_nodes(aes(color = n_dependencies, size = 7 * importance)) +
  scale_color_distiller(palette = "Spectral") +
  scale_size(labels = function(x) abs(max_downstream_deps - ceiling(x / 7 * max_downstream_deps))) +
  theme_blank(legend.position = "top") +
  guides(
    size = guide_legend(title = "Downstream dependencies", title.position = "top", title.hjust = 0.5, label.position = "bottom", label.hjust = 0.5)
    , color = guide_colorbar(title = "Upstream dependencies", title.position = "top", title.hjust = 0.5, barwidth = unit(130, "pt"), barheight = unit(4, "pt"))
  )

```

# Downloads 


```{r message=FALSE, warning=FALSE, include=TRUE, results="hide", echo=FALSE}
library(tidyverse)
library(zoo)
library(cranlogs)
library(rstanarm)
library(see)
library(ggrepel)

# Packages data
downloads_insight <- cranlogs::cran_downloads(package = "insight", from = "2019-02-26") %>% 
  mutate(Package = "insight")
downloads_bayestestR <- cranlogs::cran_downloads(package = "bayestestR", from = "2019-04-08") %>% 
  mutate(Package = "bayestestR")
downloads_performance <- cranlogs::cran_downloads(package = "performance", from = "2019-04-22") %>% 
  mutate(Package = "performance")
downloads_see <- cranlogs::cran_downloads(package = "see", from = "2019-05-22") %>% 
  mutate(Package = "see")

# Combine all data
data <- rbind(downloads_insight,
              downloads_bayestestR,
              downloads_performance,
              downloads_see) %>% 
  group_by(Package) %>% 
  mutate(cumulative_count = cumsum(count),
         average_count = zoo::rollmax(count, 10, fill=0)+10,
         day_num = as.numeric(date) - min(as.numeric(date)),
         day = weekdays(date),
         month = months(date),
         quarters = quarters(date),
         month_day = lubridate::mday(date)) %>% 
  ungroup()


events <- data.frame()
color_CRAN <- "#607D8B"
color_blog <- "#9C27B0"

# Publications
events <- rbind(events,
               data.frame(date = as.Date(c("2019-03-05", 
                                           "2019-04-09",
                                           "2019-04-24",
                                           "2019-05-24")), 
                          event=c("CRAN - insight (0.1.0)", 
                                  "CRAN - BayestestR (0.1.0)",
                                  "CRAN - performance (0.1.0)",
                                  "CRAN - see (0.1.0)"), 
                          color=color_CRAN, stringsAsFactors = FALSE))
# Blogposts
blogposts <- tidyRSS::tidyfeed("https://easystats.github.io/blog/categories/r/index.xml") %>% 
  filter(item_date_published > "2019-03-29") %>% 
  select(date = item_date_published,
         event = item_title) %>% 
  mutate(color=color_blog)

events <- rbind(events,
                blogposts)

# Full join
data <- full_join(data, events, by="date")

events <- full_join(
  events,
  group_by(data, event) %>% 
  summarise(event_y = max(average_count)), by="event") %>% 
  filter(!is.na(date))
```

### Trend
```{r, message=FALSE, warning=FALSE, eval = TRUE, fig.align='center', echo=FALSE, dpi=300}
# TIME TREND
data %>% 
  ggplot(aes(x=date, color=Package)) +
  # geom_hline(yintercept=0) +
  # geom_line(aes(y=count), size=0.75) +
  # geom_line(aes(y=count_Median), size=1, colour="blue") +
  geom_smooth(aes(y=count), method = 'loess', size=1.75, se=FALSE) +
  geom_smooth(aes(y=count), method = 'lm', size=1, se=FALSE) +
  # geom_vline(data=events, aes(xintercept = events$date), colour=events$color, size=.5) +
  geom_linerange(data=events, aes(x = date, ymin = 0, ymax = event_y), colour = events$color, size = .5) +
  geom_label_repel(data=events, aes(label = event, x = date, y = event_y), fill = events$color, colour = "white", segment.colour = events$color) +
  see::theme_modern() +
  scale_x_date(date_breaks = "1 month", 
               # limits = as.Date(c('2011-01-01','2013-01-01')),
               labels = scales::date_format("%Y-%m")) +
  scale_color_material_d() +
  # scale_color_manual(values=c("insight" = "#2196F3",
  #                             "bayestestR" = "#4CAF50",
  #                             "performance" = "#FFC107",
  #                             "see" = "#f44336")) +
  xlab("") +
  ylab("Daily CRAN Downloads\n") +
  coord_cartesian(ylim = c(0, max(data$count) + 100), expand = FALSE) +
  scale_y_sqrt()
```


### By Week Day
```{r, message=FALSE, warning=FALSE, eval = TRUE, fig.align='center', echo=FALSE, dpi=300}
junk <- capture.output(model <- rstanarm::stan_glm(count ~ Package / day, data = data, family = poisson()))

estimate::estimate_means(model) %>% 
  sjmisc::rec(day, rec = "Montag=Monday;Dienstag=Tuesday;Mittwoch=Wednesday;Donnerstag=Thursday;Freitag=Friday;Samstag=Saturday;Sonntag=Sunday;else=copy", suffix = "") %>% 
  mutate(day = fct_relevel(day, "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")) %>% 
  ggplot(aes(x=day, y=Median, group=Package)) +
  geom_ribbon(aes(ymin=CI_low, ymax=CI_high, fill=Package), alpha=0.1) +
  geom_line(aes(color=Package), size=1) +
  see::theme_modern() +
  scale_color_material_d() +
  scale_fill_material_d() +
  # scale_color_manual(values=c("insight" = "#9C27B0",
  #                             "bayestestR" = "#E91E63",
  #                             "performance" = "#4CAF50")) +
  # scale_fill_manual(values=c("insight" = "#9C27B0",
  #                             "bayestestR" = "#E91E63",
  #                             "performance" = "#4CAF50")) +
  xlab("") +
  ylab("CRAN Downloads\n") +
  # scale_y_sqrt() +
  coord_cartesian(ylim = c(0, 1200), expand = FALSE) 
```


# Convention of code-style

Following conventions apply to the easystats-ecosystem, to ensure that function and argument names as well as element names for return-values follow a consistent pattern across all packages.

**Importing other packages**

- No full import, only selective import of functions
- Use base-R wherever possible (reduce dependencies)
- Make sure R-version requirements are not too strict

**Helper-functions**

- Own re-implementation of helper-functions, if it's not too much effort (e.g. I typically use own functions to check if a string starts / ends with a pattern, or if an object (list, data frame) contains an element with a given name (like `tibble::has_name()`), to reduce dependencies.

**Function names**
- lower case, underscore separated if more than one verb
- make clever design choices, like e.g. in _insight_, where we have a common prefix for functions that do certain tasks (`get_*()` to get data, `find_*()` to find information), or in _performance_ (`performance_*()` to check model performance, `check_*()` to check model-assumptions...)

**Argument names**
- lower case, underscore separated if more than one verb

**Element / Column names** (for returned data frames)

1) First letter of the column name is capital, unless (6) applies (_example:_ `Parameter`)
2) First letter of nouns is capital, unless (6) applies (_example:_ `ROPE_Percentage`, `Prior_Scale`)
3) Using underscore rather than camelCase to separate words (_example:_ `CI_high`)
4) Multiple words: common/main part first and adjective/specifier/variational part after (_example:_ `Median_standardized`, `ROPE_percentage`)
5) Abbreviations: all uppercase (_example:_ `ESS`, `MCSE`, `ROPE`)
6) Keep conventions for reserved words (_example:_ `p`, `pd`, `Rhat`)
7) Adjectives / verbs: all lower case, unless (1) applies (_example:_ `high` or `low` in `CI_high` or `CI_low`)

# List of functions



```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# it would be cool to add the title / description for all functions
library(insight)
library(bayestestR)
library(parameters)
library(performance)
library(correlation)
library(estimate)
library(report)

all_funs <- data.frame()

for (package in c("insight", "bayestestR", "parameters", "performance", "correlation", "estimate", "report", "see")) {
  
  name <- lsf.str(paste0("package:", package))
  name <- unlist(strsplit(name, " "))
  
  functions <- paste0("[**`", 
                      name, 
                      "`**](https://easystats.github.io/", 
                      package, 
                      "/reference/index.html)",
                      " *(",
                      package,
                      ")*")
  
  functions <- data.frame("Functions" = functions,
                          "Package" = package,
                          "Name" = name)
  

  all_funs <- rbind(all_funs, functions)
}



all_funs <- all_funs[!duplicated(all_funs$Name),]
all_funs <- sort(as.character(all_funs$Functions))
cat(paste0(c("", all_funs), collapse = "\n- "))
```

